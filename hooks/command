#!/usr/bin/env bash
set -euo pipefail

REGISTRY="${BUILDKITE_PLUGIN_PACKAGE_DELETE_REGISTRY}"
ARTIFACTS="${BUILDKITE_PLUGIN_PACKAGE_DELETE_ARTIFACTS}"

# Parse registry into org_slug and registry_slug
if [[ "$REGISTRY" == */* ]]; then
  ORG_SLUG="${REGISTRY%%/*}"
  REGISTRY_SLUG="${REGISTRY#*/}"
else
  ORG_SLUG="${BUILDKITE_ORGANIZATION_SLUG}"
  REGISTRY_SLUG="${REGISTRY}"
fi

API_BASE="https://api.buildkite.com/v2/packages/organizations/${ORG_SLUG}/registries/${REGISTRY_SLUG}"

# Download artifacts from previous steps
DOWNLOAD_DIR="$(mktemp -d)"
trap 'rm -rf "$DOWNLOAD_DIR"' EXIT

echo "--- :package: Downloading artifacts matching ${ARTIFACTS}"
buildkite-agent artifact download "${ARTIFACTS}" "${DOWNLOAD_DIR}"

# Parse wheel filenames into unique "name version" pairs
# PEP 427: {name}-{version}-{python}-{abi}-{platform}.whl
PAIRS_FILE="$(mktemp)"
trap 'rm -rf "$DOWNLOAD_DIR" "$PAIRS_FILE"' EXIT

while IFS= read -r -d '' file; do
  filename="${file##*/}"
  case "$filename" in
    *.whl)
      name="$(echo "$filename" | cut -d- -f1)"
      version="$(echo "$filename" | cut -d- -f2)"
      echo "${name} ${version}" >> "$PAIRS_FILE"
      ;;
    *)
      echo "Warning: unsupported package format '${filename}', skipping" >&2
      ;;
  esac
done < <(find "$DOWNLOAD_DIR" -type f -print0)

if [[ ! -s "$PAIRS_FILE" ]]; then
  echo "No parseable package artifacts found matching ${ARTIFACTS}"
  exit 0
fi

# Deduplicate (e.g. multiple wheels for same package — different platforms)
UNIQUE_PAIRS="$(sort -u "$PAIRS_FILE")"

# Get OIDC token
echo "--- :key: Requesting OIDC token"
OIDC_TOKEN="$(buildkite-agent oidc request-token \
  --audience "https://packages.buildkite.com/${ORG_SLUG}/${REGISTRY_SLUG}" \
  --lifetime 300)"

FAILED=0

while IFS=' ' read -r name version; do
  echo "--- :wastebasket: Deleting ${name} v${version} from ${ORG_SLUG}/${REGISTRY_SLUG}"

  PACKAGE_ID=""
  PAGE=1

  while :; do
    REQUEST_URL="${API_BASE}/packages?name=${name}&page=${PAGE}&per_page=100"
    echo "DEBUG: GET ${REQUEST_URL}" >&2

    RESPONSE="$(curl --silent --fail-with-body \
      -H "Authorization: Bearer ${OIDC_TOKEN}" \
      "${REQUEST_URL}")"

    echo "DEBUG: Looking for name='${name}' version='${version}'" >&2
    echo "DEBUG: Packages in response:" >&2
    echo "$RESPONSE" | jq -r '.items[] | "  name=\(.name) version=\(.version) id=\(.id)"' >&2

    MATCH="$(echo "$RESPONSE" | jq -r \
      --arg name "$name" \
      --arg version "$version" \
      '.items[] | select((.name | gsub("_"; "-")) == ($name | gsub("_"; "-")) and .version == $version) | .id')"

    echo "DEBUG: MATCH='${MATCH}'" >&2

    if [[ -n "$MATCH" ]]; then
      PACKAGE_ID="$MATCH"
      break
    fi

    COUNT="$(echo "$RESPONSE" | jq '.items | length')"
    echo "DEBUG: Page ${PAGE} returned ${COUNT} items" >&2
    if [[ "$COUNT" -lt 100 ]]; then
      break
    fi

    PAGE=$((PAGE + 1))
  done

  if [[ -z "$PACKAGE_ID" ]]; then
    echo "No existing package found for ${name} v${version} — nothing to delete"
    continue
  fi

  echo "Found package ${PACKAGE_ID}, deleting..."

  HTTP_STATUS="$(curl --silent --output /dev/null --write-out '%{http_code}' \
    -X DELETE \
    -H "Authorization: Bearer ${OIDC_TOKEN}" \
    "${API_BASE}/packages/${PACKAGE_ID}")"

  if [[ "$HTTP_STATUS" -ge 200 && "$HTTP_STATUS" -lt 300 ]]; then
    echo "Deleted ${name} v${version} (${PACKAGE_ID})"
  else
    echo "Failed to delete ${name} v${version} — API returned HTTP ${HTTP_STATUS}" >&2
    FAILED=1
  fi
done <<< "$UNIQUE_PAIRS"

if [[ "$FAILED" -ne 0 ]]; then
  exit 1
fi
